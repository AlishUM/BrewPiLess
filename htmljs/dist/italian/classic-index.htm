<!DOCTYPE html><html lang="it"><head><meta http-equiv=content-type content="text/html; charset=utf-8"><meta name=viewport content="width=device-width,initial-scale=1"><title> BrewPiLess in servizio! </title><meta name=apple-mobile-web-app-title content=BrewPiLess><meta name=apple-mobile-web-app-capable content=yes><script src=http://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js></script><script>!function(n,r){"function"==typeof define&&define.amd?define("regression",r):"undefined"!=typeof module?module.exports=r():n.regression=r()}(this,function(){"use strict";function v(n,i){var o=n.reduce(function(n,r){return n+r[1]},0)/n.length,r=n.reduce(function(n,r){var t=r[1]-o;return n+t*t},0);return 1-n.reduce(function(n,r,t){var o=i[t],e=r[1]-o[1];return n+e*e},0)/r}function d(n,r){var t=Math.pow(10,r);return Math.round(n*t)/t}var i={linear:function(n,r,t){for(var o,e,i,u=[0,0,0,0,0],a=n.length,l=0;l<a;l++)null!==n[l][1]&&(u[0]+=n[l][0],u[1]+=n[l][1],u[2]+=n[l][0]*n[l][0],u[3]+=n[l][0]*n[l][1],u[4]+=n[l][1]*n[l][1]);return e=(a*u[3]-u[0]*u[1])/(a*u[2]-u[0]*u[0]),i=u[1]/a-e*u[0]/a,o=n.map(function(n){var r=n[0];return[r,e*r+i]}),{r2:v(n,o),equation:[e,i],points:o,string:"y = "+d(e,t.precision)+"x + "+d(i,t.precision)}},linearthroughorigin:function(n,r,t){for(var o,e,i=[0,0],u=0;u<n.length;u++)null!==n[u][1]&&(i[0]+=n[u][0]*n[u][0],i[1]+=n[u][0]*n[u][1]);return o=i[1]/i[0],e=n.map(function(n){var r=n[0];return[r,o*r]}),{r2:v(n,e),equation:[o],points:e,string:"y = "+d(o,t.precision)+"x"}},exponential:function(n,r,t){for(var o,e,i,u,a=[0,0,0,0,0,0],l=0;l<n.length;l++)null!==n[l][1]&&(a[0]+=n[l][0],a[1]+=n[l][1],a[2]+=n[l][0]*n[l][0]*n[l][1],a[3]+=n[l][1]*Math.log(n[l][1]),a[4]+=n[l][0]*n[l][1]*Math.log(n[l][1]),a[5]+=n[l][0]*n[l][1]);return o=a[1]*a[2]-a[5]*a[5],e=Math.exp((a[2]*a[3]-a[5]*a[4])/o),i=(a[1]*a[4]-a[5]*a[3])/o,u=n.map(function(n){var r=n[0];return[r,e*Math.exp(i*r)]}),{r2:v(n,u),equation:[e,i],points:u,string:"y = "+d(e,t.precision)+"e^("+d(i,t.precision)+"x)"}},logarithmic:function(n,r,t){for(var o,e,i,u=[0,0,0,0],a=n.length,l=0;l<a;l++)null!==n[l][1]&&(u[0]+=Math.log(n[l][0]),u[1]+=n[l][1]*Math.log(n[l][0]),u[2]+=n[l][1],u[3]+=Math.pow(Math.log(n[l][0]),2));return e=(a*u[1]-u[2]*u[0])/(a*u[3]-u[0]*u[0]),o=(u[2]-e*u[0])/a,i=n.map(function(n){var r=n[0];return[r,o+e*Math.log(r)]}),{r2:v(n,i),equation:[o,e],points:i,string:"y = "+d(o,t.precision)+" + "+d(e,t.precision)+" ln(x)"}},power:function(n,r,t){for(var o,e,i,u=[0,0,0,0],a=n.length,l=0;l<a;l++)null!==n[l][1]&&(u[0]+=Math.log(n[l][0]),u[1]+=Math.log(n[l][1])*Math.log(n[l][0]),u[2]+=Math.log(n[l][1]),u[3]+=Math.pow(Math.log(n[l][0]),2));return e=(a*u[1]-u[2]*u[0])/(a*u[3]-u[0]*u[0]),o=Math.exp((u[2]-e*u[0])/a),i=n.map(function(n){var r=n[0];return[r,o*Math.pow(r,e)]}),{r2:v(n,i),equation:[o,e],points:i,string:"y = "+d(o,t.precision)+"x^"+d(e,t.precision)}},polynomial:function(n,r,t){var o,e,i,u,a,l,p,f,s=[],c=[],h=0,g=0,M=n.length;for(e=void 0===r?3:r+1,i=0;i<e;i++){for(a=0;a<M;a++)null!==n[a][1]&&(h+=Math.pow(n[a][0],i)*n[a][1]);for(s.push(h),o=[],u=h=0;u<e;u++){for(a=0;a<M;a++)null!==n[a][1]&&(g+=Math.pow(n[a][0],i+u));o.push(g),g=0}c.push(o)}for(c.push(s),p=function(n,r){var t=0,o=0,e=0,i=0,u=0,a=n.length-1,l=new Array(r);for(t=0;t<a;t++){for(o=(i=t)+1;o<a;o++)Math.abs(n[t][o])>Math.abs(n[t][i])&&(i=o);for(e=t;e<a+1;e++)u=n[e][t],n[e][t]=n[e][i],n[e][i]=u;for(o=t+1;o<a;o++)for(e=a;t<=e;e--)n[e][o]-=n[e][t]*n[t][o]/n[t][t]}for(o=a-1;0<=o;o--){for(u=0,e=o+1;e<a;e++)u+=n[e][o]*l[e];l[o]=(n[a][o]-u)/n[o][o]}return l}(c,e),l=n.map(function(n){var o=n[0],r=p.reduce(function(n,r,t){return n+r*Math.pow(o,t)},0);return[o,r]}),f="y = ",i=p.length-1;0<=i;i--)f+=1<i?d(p[i],t.precision)+"x^"+i+" + ":1===i?d(p[i],t.precision)+"x + ":d(p[i],t.precision);return{r2:v(n,l),equation:p,points:l,string:f}},lastvalue:function(n,r,t){for(var o=[],e=null,i=0;i<n.length;i++)null!==n[i][1]&&isFinite(n[i][1])?(e=n[i][1],o.push([n[i][0],n[i][1]])):o.push([n[i][0],e]);return{r2:v(n,o),equation:[e],points:o,string:""+d(e,t.precision)}}};return function(n,r,t,o){var e="object"==typeof t&&void 0===o?t:o||{};return e.precision||(e.precision=2),"string"==typeof n?i[n.toLowerCase()](r,t,e):null}})</script><script>var JSVERSION = "4.0";

function s_ajax(b) {
    var c = new XMLHttpRequest();
    c.onreadystatechange = function() {
        if (c.readyState == 4) {
            if (c.status == 200) {
                b.success(c.responseText)
            } else {
                c.onerror(c.status)
            }
        }
    };
    c.ontimeout = function() {
        if (typeof b["timeout"] != "undefined") b.timeout();
        else c.onerror(-1)
    }, c.onerror = function(a) {
        if (typeof b["fail"] != "undefined") b.fail(a)
    };
    c.open(b.m, b.url, true);
    if (typeof b["data"] != "undefined") {
        c.setRequestHeader("Content-Type", (typeof b["mime"] != "undefined") ? b["mime"] : "application/x-www-form-urlencoded");
        c.send(b.data)
    } else c.send()
}

var Q = function(d) {
    return document.querySelector(d);
};

function C2F(c) {
    return Math.round((c * 1.8 + 32) * 10) / 10
}

function F2C(f) {
    return Math.round((f - 32) / 1.8 * 10) / 10
}

function openDlgLoading() {
    document.getElementById('dlg_loading').style.display = "block";
}

function closeDlgLoading() {
    document.getElementById('dlg_loading').style.display = "none";
}

var BrewMath = {
    abv: function(og, fg) {
        return ((76.08 * (og - fg) / (1.775 - og)) * (fg / 0.794)).toFixed(1);
    },
    abvP: function(og, fg) {
        return BrewMath.abv(BrewMath.pla2sg(og), BrewMath.pla2sg(fg));
    },
    att: function(og, fg) {
        return Math.round((og - fg) / (og - 1) * 100);
    },
    attP: function(pog, pfg) {
        return Math.round((pog - pfg) / pog * 100);
    },
    sg2pla: function(sg) {
        return (((182.4601 * sg - 775.6821) * sg + 1262.7794) * sg - 669.5622);
    },
    pla2sg: function(pla) {
        return 1 + (pla / (258.6 - ((pla / 258.2) * 227.1)));
    },
    tempCorrectionF(sg, t, c) {
        var nsg = sg * ((1.00130346 - 0.000134722124 * t + 0.00000204052596 * t * t - 0.00000000232820948 * t * t * t) /
            (1.00130346 - 0.000134722124 * c + 0.00000204052596 * c * c - 0.00000000232820948 * c * c * c));
        return nsg;
    },
    pTempCorrectionF(sg, t, c) {
        return BrewMath.sg2pla(BrewMath.tempCorrectionF(BrewMath.pla2sg(sg), t, c));
    },
    tempCorrection(celsius, sg, t, c) {
        return celsius ? BrewMath.tempCorrectionF(sg, C2F(t), C2F(c)) : BrewMath.tempCorrectionF(sg, t, c);
    },
    pTempCorrection(celsius, sg, t, c) {
        return celsius ? BrewMath.pTempCorrectionF(sg, C2F(t), C2F(c)) : BrewMath.tempCorrectionF(sg, t, c);
    }
};

Date.prototype.shortLocalizedString = function() {
    var y = this.getYear() + 1900;
    var re = new RegExp('[^\d]?' + y + '[^\d]?');
    var n = this.toLocaleDateString();
    var ds = n.replace(re, "");
    var HH = this.getHours();
    var MM = this.getMinutes();

    function T(x) {
        return (x > 9) ? x : ("0" + x);
    }
    return ds + " " + T(HH) + ":" + T(MM);
};

function getActiveNavItem() {
    var path = window.location.pathname.split("/").pop();
    if (path == "") path = "index.htm";
    var element = Q('.options>li>a[href="/' + path + '"]');
    element.className += 'active';
}

function formatDate(dt) {
    //	var y = dt.getFullYear();
    //	var M = dt.getMonth() +1;
    //	var d = dt.getDate();
    var h = dt.getHours();
    var m = dt.getMinutes();
    //    var s = dt.getSeconds();
    function dd(n) {
        return (n < 10) ? '0' + n : n;
    }
    //	return dd(M) + "/" + dd(d) + "/" + y +" "+ dd(h) +":"+dd(m)+":"+dd(s);
    //	return dd(M) + "/" + dd(d) +" "+ dd(h) +":"+dd(m);
    return dt.toLocaleDateString() + " " + dd(h) + ":" + dd(m);
}

function formatDateForPicker(date) {
    var h = date.getHours();
    var m = date.getMinutes();

    function dd(n) { return (n < 10) ? '0' + n : n; }
    return date.getFullYear() + "-" + dd(date.getMonth() + 1) + "-" + dd(date.getDate()) + "T" + dd(h) + ":" + dd(m);
}</script><script>function invoke(e){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&(200==n.status?e.success(n.responseText):n.onerror(n.status))},n.ontimeout=function(){void 0!==e.timeout?e.timeout():n.onerror(-1)},n.onerror=function(n){void 0!==e.fail&&e.fail(n)},n.open(e.m,e.url,!0),void 0!==e.data?(n.setRequestHeader("Content-Type",void 0!==e.mime?e.mime:"application/x-www-form-urlencoded"),n.send(e.data)):n.send()}var BWF={BrewProfile:"/brewing.json",process:function(msg){if(null==this.raw)for(var key in eval("m={"+msg+"}"),m)void 0!==this.handlers[key]&&this.handlers[key](m[key]);else this.raw(msg)},on:function(n,e){this.handlers[n]=e},send:function(n){1==this.ws.readyState&&this.ws.send(n)},reconnecting:!1,connect:function(){var e=this;if("undefined"!=typeof WebSocket){var n=new WebSocket("ws://"+document.location.host+"/ws");(e.ws=n).onopen=function(){console.log("Connected"),e.onconnect()},n.onclose=function(){e.reconnecting||(console.log("WS close"),e.error(-2),e.auto&&setTimeout(function(){e.reconnect()},5e3))},n.onmessage=function(n){e.process(n.data)}}else alert("Error! WebSocket Not Supported!")},reconnect:function(n){n=void 0!==n;var e=this;e.reconnecting||(n||1!=e.ws.readyState)&&(console.log("reconnect forced:"+n+" state:"+e.ws.readyState),e.reconnecting=!0,e.ws.close(),e.connect(),e.reconnecting=!1)},init:function(n){var e=this;e.error=void 0===n.error?function(){}:n.error,e.handlers=void 0===n.handlers?{}:n.handlers,e.raw=void 0===n.raw?null:n.raw,e.onconnect=void 0===n.onconnect?function(){}:n.onconnect,e.auto=void 0===n.reconnect||n.reconnect,e.connect()},save:function(n,e,o,t){invoke({m:"POST",url:"/fputs",data:"path="+n+"&content="+encodeURIComponent(e),success:function(){o()},fail:function(n){t(n)}})},load:function(n,e,o){invoke({m:"GET",url:n,success:function(n){e(n)},fail:function(n){o(n)}})}}</script><script>var CHART_VERSION=6,GravityFilter={b:.1,y:0,reset:function(){this.y=0},add:function(e){return 0==this.y?this.y=e:this.y=this.y+this.b*(e-this.y),Math.round(1e4*this.y)/1e4},setBeta:function(e){this.b=e}},GravityTracker={NumberOfSlots:48,InvalidValue:255,ridx:0,record:[],threshold:1,setThreshold:function(e){this.threshold=e},addRecord:function(e){this.record[this.ridx++]=e,this.ridx>=this.NumberOfSlots&&(this.ridx=0)},stable:function(e,t){t=void 0===t?this.threshold:t;var a=this.ridx-1;a<0&&(a=this.NumberOfSlots-1);for(var r=this.NumberOfSlots+this.ridx-e;r>=this.NumberOfSlots;)r-=this.NumberOfSlots;return this.record[r]-this.record[a]<=t},Period:3600,init:function(){this.curerntStart=0,this.lastValue=0},add:function(e,t){var a=t-this.curerntStart;if(a>this.Period){if(this.addRecord(e),0!=this.lastValue)for(a-=this.Period;a>this.Period;)a-=this.Period,this.addRecord(this.lastValue);this.curerntStart=t,this.lastValue=e}}};function fgstate(e){Q("#fgstate").style.backgroundColor={0:"red",12:"orange",24:"yellow",48:"green"}[e]}function checkfgstate(){GravityTracker.stable(12)?GravityTracker.stable(24)?GravityTracker.stable(48)?fgstate(48):fgstate(24):fgstate(12):fgstate(0)}var GravityAndTiltIndex=6,PSIIndex=7,RoomTemperatureIndex=4,BrewChart=function(e){var t=this;t.cid=e,t.ctime=0,t.interval=60,t.numLine=7,t.numData=8,t.calculateSG=!1,t.calibrating=!1,t.lidx=0,t.celius=!0,t.clearData()},colorIdle="white",colorCool="rgba(0, 0, 255, 0.4)",colorHeat="rgba(255, 0, 0, 0.4)",colorWaitingHeat="rgba(255, 0, 0, 0.2)",colorWaitingCool="rgba(0, 0, 255, 0.2)",colorHeatingMinTime="rgba(255, 0, 0, 0.6)",colorCoolingMinTime="rgba(0, 0, 255, 0.6)",colorWaitingPeakDetect="rgba(0, 0, 0, 0.2)",colorPressure="#0000EE",STATE_LINE_WIDTH=15,STATES=[{name:"IDLE",color:colorIdle,text:"non attivo"},{name:"STATE_OFF",color:colorIdle,text:"Spento"},{name:"DOOR_OPEN",color:"#eee",text:"Porta aperta",doorOpen:!0},{name:"HEATING",color:colorHeat,text:"Scaldando"},{name:"COOLING",color:colorCool,text:"Raffredando"},{name:"WAITING_TO_COOL",color:colorWaitingCool,text:"In attesa di raffredare",waiting:!0},{name:"WAITING_TO_HEAT",color:colorWaitingHeat,text:"In attesa di scaldare",waiting:!0},{name:"WAITING_FOR_PEAK_DETECT",color:colorWaitingPeakDetect,text:"In attesa per il Peak",waiting:!0},{name:"COOLING_MIN_TIME",color:colorCoolingMinTime,text:"Tempo minimo di raffredamento",extending:!0},{name:"HEATING_MIN_TIME",color:colorHeatingMinTime,text:"Tempo minimo di riscaldamento",extending:!0},{name:"INVALID",color:colorHeatingMinTime,text:"Stato invalido"}];BrewChart.Mode={b:"Beer Constant",f:"Fridge Constant",o:"Off",p:"Profile"},BrewChart.Colors=["rgb(240, 100, 100)","rgb(41,170,41)","rgb(89, 184, 255)","rgb(255, 161, 76)","#AAAAAA","#f5e127","rgb(153,0,153)","#000abb",colorPressure],BrewChart.Labels=["Time","beerSet","beerTemp","fridgeTemp","fridgeSet","roomTemp","auxTemp","gravity","filtersg"],BrewChart.ClassLabels=["","beer-set","beer-temp","fridge-temp","fridge-set","room-temp","aux-temp","gravity","filtersg"];var BeerTempLine=2,BeerSetLine=1,FridgeTempLine=3,FridgeSetLine=4,RoomTempLine=5,AuxTempLine=6,GravityLineIndex=7,FilteredSgLine=8,PressureLine=9,PressureSetLine=10,CarbonationLine=11,PSIDataIndex=8;BrewChart.prototype.clearData=function(){this.laststat=[NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN],this.sg=NaN,this.og=NaN},BrewChart.prototype.setCelius=function(e){this.celius=e,this.ylabel(STR.ChartLabel+"("+(e?"°C":"°F")+")")},BrewChart.prototype.incTime=function(){this.ctime+=this.interval},BrewChart.prototype.formatDate=function(e){var t=e.getHours(),a=e.getMinutes(),r=e.getSeconds();function i(e){return 9<e?e:"0"+e}return e.toLocaleDateString()+" "+i(t)+":"+i(a)+":"+i(r)},BrewChart.prototype.formatDuration=function(e){var t="",a=Math.floor(e/86400);return 0<a&&(t=a+"d",e-=86400*a),t=t+(e/3600).toFixed(1)+"h"},BrewChart.prototype.showLegend=function(e,t){var a=new Date(e);Q(".beer-chart-legend-time").innerHTML=this.formatDate(a),Q(".beer-chart-legend-elapse")&&(Q(".beer-chart-legend-elapse").innerHTML=this.formatDuration(a.getTime()/1e3-this.starttime)),Q(".chart-legend-row.beer-temp .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,BeerTempLine)),Q(".chart-legend-row.beer-set .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,BeerSetLine)),Q(".chart-legend-row.fridge-temp .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,FridgeTempLine)),Q(".chart-legend-row.fridge-set .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,FridgeSetLine)),Q(".chart-legend-row.room-temp .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,RoomTempLine)),Q(".chart-legend-row.aux-temp .legend-value").innerHTML=this.tempFormat(this.chart.getValue(t,AuxTempLine));var r=this.chart.getValue(t,GravityLineIndex);Q(".chart-legend-row.gravity .legend-value").innerHTML=!r||isNaN(r)?"--":this.plato?r.toFixed(2)+"&deg;P":r.toFixed(4);var i=this.chart.getValue(t,FilteredSgLine);Q(".chart-legend-row.filtersg .legend-value").innerHTML=!i||isNaN(i)?"--":this.plato?i.toFixed(2)+"&deg;P":i.toFixed(4);var n=parseInt(this.state[t]);if(isNaN(n)||(Q(".beer-chart-state").innerHTML=STATES[n].text),this.psiAvail){var o=this.pchart.getValue(t,1);Q(".chart-legend-row.pressure .legend-value").innerHTML=null==o||isNaN(o)?"--":o.toFixed(1);var s=this.pchart.getValue(t,2);Q(".chart-legend-row.pressure-set .legend-value").innerHTML=null==s||isNaN(s)?"--":Math.round(s);var l=this.pchart.getValue(t,3);Q(".chart-legend-row.carbonation .legend-value").innerHTML=null==l||isNaN(l)?"--":l.toFixed(1)}},BrewChart.prototype.hideLegend=function(){document.querySelectorAll(".legend-value").forEach(function(e){e.innerHTML="--"}),Q(".beer-chart-legend-time").innerHTML=this.dateLabel,Q(".beer-chart-state").innerHTML="stato"},BrewChart.prototype.tempFormat=function(e){var t=parseFloat(e);if(isNaN(t))return"--";var a=this.celius?"&deg;C":"&deg;F";return parseFloat(t).toFixed(2)+a},BrewChart.prototype.initLegend=function(){if(Q(".beer-temp .toggle"))for(var e=1;e<BrewChart.ClassLabels.length;e++){var t=BrewChart.ClassLabels[e];Q(".chart-legend-row."+t).style.color=BrewChart.Colors[e-1],Q("."+t+".toggle").style.backgroundColor=BrewChart.Colors[e-1]}this.dateLabel=Q(".beer-chart-legend-time").innerHTML},BrewChart.prototype.togglePsiLine=function(e){var t=this;t.psiAvail&&(t.showPsi=!t.showPsi,t.showPsi?this.pchart.setVisibility(e-PressureLine,!0):this.pchart.setVisibility(e-PressureLine,!1))},BrewChart.prototype.toggleLine=function(e){var t=this;t.shownlist[e]=!t.shownlist[e];var a=BrewChart.ClassLabels[e];t.shownlist[e]?(Q("."+a+" .toggle")&&(Q("."+a+" .toggle").style.backgroundColor=Q(".chart-legend-row."+a).style.color),t.chart.setVisibility(e-1,!0)):(Q("."+a+" .toggle")&&(Q("."+a+" .toggle").style.backgroundColor="transparent"),t.chart.setVisibility(e-1,!1))},BrewChart.prototype.setLabels=function(e,t){this.ylabel=e,this.y2label=t},BrewChart.prototype.setPChart=function(e,t,a){this.pcid=e,this.plabel=t,this.clabel=a},BrewChart.prototype.createPSIChart=function(){var i=this,e=document.createElement("div");e.className="hide",document.body.appendChild(e);var t={labels:["Time","psi","psiset","co2"],colors:[colorPressure,"rgb(240, 100, 100)","gray"],connectSeparatedPoints:!0,ylabel:i.plabel,y2label:i.clabel,series:{co2:{axis:"y2",drawPoints:!1}},axisLabelFontSize:12,gridLineColor:"#ccc",gridLineWidth:"0.1px",labelsDiv:e,labelsDivStyles:{display:"none"},strokeWidth:1,axes:{y:{valueFormatter:function(e){return e.toFixed(1)},axisLabelFormatter:function(e){return e.toFixed(1)}},y2:{valueFormatter:function(e){return e.toFixed(1)},axisLabelFormatter:function(e){return e.toFixed(1)}}},highlightCallback:function(e,t,a,r){i.showLegend(t,r)},unhighlightCallback:function(e){i.hideLegend()}};i.pchart=new Dygraph(document.getElementById(i.pcid),i.psi,t),i.pchart.setVisibility(0,!0)},BrewChart.prototype.createChart=function(){var i=this;i.initLegend(),i.shownlist=[!0,!0,!0,!0,!0,!0,!0,!0,!0],i.showPsi=!0;var e=document.createElement("div");e.className="hide";var t=(i.ylabel?i.ylabel:"Temperature")+"(&deg;"+(i.celius?"C":"F")+")",a=i.y2label?i.y2label:"Gravity";document.body.appendChild(e);var r={labels:BrewChart.Labels,colors:BrewChart.Colors,connectSeparatedPoints:!0,ylabel:t,y2label:a,series:{gravity:{axis:"y2",drawPoints:!0,pointSize:2,highlightCircleSize:4},filtersg:{axis:"y2"}},axisLabelFontSize:12,animatedZooms:!0,gridLineColor:"#ccc",gridLineWidth:"0.1px",labelsDiv:e,labelsDivStyles:{display:"none"},displayAnnotations:!0,strokeWidth:1,axes:{y:{valueFormatter:function(e){return i.tempFormat(e)}},y2:{valueFormatter:function(e){return i.plato?e.toFixed(1):e.toFixed(3)},axisLabelFormatter:function(e){var t=this.yAxisRange(1);return i.plato?1<t[1]-t[0]?e.toFixed(1):e.toFixed(2):.002<t[1]-t[0]?e.toFixed(3).substring(1):e.toFixed(4).substring(2)}}},highlightCircleSize:2,highlightSeriesOpts:{strokeWidth:1.5,strokeBorderWidth:1,highlightCircleSize:5},highlightCallback:function(e,t,a,r){i.showLegend(t,r)},unhighlightCallback:function(e){i.hideLegend()},underlayCallback:function(e,t,a){e.save();try{i.drawBackground(e,t,a)}finally{e.restore()}}};i.chart=new Dygraph(document.getElementById(i.cid),i.data,r)},BrewChart.prototype.findNearestRow=function(e,t){"use strict";for(var a,r,i=0,n=e.numRows()-1;i<n;)if(a=Math.floor((i+n)/2),(r=e.getValue(a,0)-t)<0)i=a+1;else{if(!(0<r))return a;n=a-1}return i},BrewChart.prototype.findStateBlocks=function(e,t,a){"use strict";for(var r,i=[],n=this.state[t],o=t;o<a;o++)(r=this.state[o])!==n&&(i.push({row:o,state:n}),n=r);return i.push({row:a,state:n}),i},BrewChart.prototype.getTime=function(e,t){"use strict";return t>=e.numRows()&&(t=e.numRows()-1),e.getValue(t,0)},BrewChart.prototype.drawBackground=function(e,t,a){var r=a.toDataXCoord(t.x),i=a.toDataXCoord(t.x+t.w),n=Math.max(this.findNearestRow(a,r)-1,0),o=this.findNearestRow(a,i)+1;if(null!==n&&null!==o)for(var s=this.findStateBlocks(a,n,o),l=0,h=0;h<s.length;h++){var c=s[h],d=c.row,u=(this.getTime(a,d)-r)/(i-r),g=Math.floor(t.x+t.w*u),p=STATES[parseInt(c.state,10)];void 0===p&&(p=STATES[0]),e.fillStyle=p.color,e.fillRect(l,t.h-STATE_LINE_WIDTH,g-l,t.h),l=g}},BrewChart.prototype.addMode=function(e,t){var a=String.fromCharCode(e);this.anno.push({series:"beerTemp",x:t,shortText:a.toUpperCase(),text:BrewChart.Mode[a],attachAtBottom:!0})},BrewChart.testData=function(e){if(255!=e[0])return!1;var t=7&e[1];return t==CHART_VERSION&&{sensor:t,f:16&e[1]}},BrewChart.prototype.addResume=function(e){this.anno.push({series:"beerTemp",x:1e3*this.ctime,shortText:"R",text:"Resume",attachAtBottom:!0})},BrewChart.prototype.getTiltAround=function(e){var t=this,a=-1,r=-1;if(null!=t.angles[e])return[t.angles[e],t.data[e][AuxTempLine]];for(var i=e-1;0<=i;i--)if(null!=t.angles[i]){a=i;break}for(i=e+1;0<(i<t.angles.length);i++)if(null!=t.angles[i]){r=i;break}return a<0&&r<0?null:a<0?[t.angles[r],t.data[r][AuxTempLine]]:r<0?[t.angles[a],t.data[a][AuxTempLine]]:[t.angles[a]+(t.angles[r]-t.angles[a])/(r-a)*(e-a),(t.data[a][AuxTempLine]+t.data[r][AuxTempLine])/2]},BrewChart.prototype.getCalibration=function(){for(var e=[],t=0;t<this.data.length;t++)if(this.rawSG[t]){var a=this.getTiltAround(t);if(a){var r,i=this.celius?C2F(a[1]):a[1],n=this.rawSG[t];r=this.plato?BrewMath.sg2pla(BrewMath.tempCorrectionF(BrewMath.pla2sg(n),C2F(this.coTemp),i)):BrewMath.tempCorrectionF(n,C2F(this.coTemp),i),e.push([a[0],r])}}return e.push([this.tiltInWater,this.readingInWater]),e},BrewChart.prototype.filterPoints=function(e,t){for(var a=[],r=0;r<e.length;r++)t&1<<r||a.push(e[r]);return a},BrewChart.prototype.setIgnoredMask=function(e){return this.cal_igmask!=e&&(this.cal_igmask=e,!0)},BrewChart.prototype.getFormula=function(){var e=this.getCalibration();if(!(e.length<2)){var t=this.filterPoints(e,this.cal_igmask);t.length<2&&(t=e,this.cal_igmask=0);var a=regression("polynomial",t,3<t.length?3:2<t.length?2:1,{precision:9});this.calibrationPoints=e,this.calculateSG=!0,this.sgByTilt=3<t.length?function(e){return a.equation[0]+a.equation[1]*e+a.equation[2]*e*e+a.equation[3]*e*e*e}:2<t.length?function(e){return a.equation[0]+a.equation[1]*e+a.equation[2]*e*e}:function(e){return a.equation[0]+a.equation[1]*e},this.coefficients=3<t.length?[a.equation[0],a.equation[1],a.equation[2],a.equation[3]]:2<t.length?[a.equation[0],a.equation[1],a.equation[2],0]:[a.equation[0],a.equation[1],0,0],this.npt=e.length}},BrewChart.prototype.process=function(e){var t=!1,a=!1,r=this;r.filterSg=null;for(var i=0;i<e.length;){var n=e[i++],o=e[i++];if(255==n){if((15&o)!=CHART_VERSION)return void alert("Versione diversa Log!");r.celius=!(16&o),r.calibrating=!(32&o),r.plato=!(64&o);var s=e[i++];s=256*s+e[i++],r.interval=s,r.starttime=(e[i]<<24)+(e[i+1]<<16)+(e[i+2]<<8)+e[i+3],r.ctime=r.starttime,i+=4,r.data=[],r.anno=[],r.state=[],r.angles=[],r.rawSG=[],r.psi=[],r.cstate=0,r.coTemp=20,r.cal_igmask=0,r.specificGravity=null,r.targetPsi=NaN,this.clearData(),t=!0,r.psiAvail=!1,GravityFilter.reset(),GravityTracker.init()}else if(243==n)r.coTemp=o;else if(244==n)r.addMode(o,1e3*r.ctime);else if(245==n)r.targetPsi=0==o?NaN:o;else if(241==n)r.cstate=o;else if(246==n)r.ctime=(e[i]<<24)+(e[i+1]<<16)+(e[i+2]<<8)+e[i+3];else if(254==n){r.lidx=0;var l=e[i++],h=e[i++]+(l<<8)+(o<<16);2592e3<h&&(h=1800);var c=r.starttime+h;c>r.ctime&&(r.data.push([new Date(1e3*r.ctime),NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN]),r.state.push(null),r.angles.push(null),r.rawSG.push.null,c-r.ctime>r.interval?r.ctime=c:r.ctime+=r.interval),r.addResume(o)}else if(248==n){var d=256*(127&e[i++])+e[i++];r.og=r.plato?d/100:d/1e4}else if(251==n){d=256*(127&e[i++])+e[i++];r.specificGravity=r.plato?d/100:d/1e4}else if(250==n){var u=e[i++],g=e[i++];r.cal_igmask=(o<<14)+(u<<7)+g}else if(249==n){d=256*(127&e[i++])+e[i++];r.tiltInWater=d/100,r.plato?r.readingInWater=0:r.readingInWater=0==o?1:.9+o/1e3}else if(240==n){r.changes=o,r.lidx=0;var p=new Date(1e3*this.ctime);r.dataset=[p],r.processRecord()}else if(n<128){var f=256*n+o;r.lidx==GravityAndTiltIndex?r.calibrating?f=32767==f?NaN:f/100:(f=32767==f?NaN:r.plato?f/100:8e3<f?f/1e4:f/1e3,a=!0):r.lidx==PSIIndex?f=32767==f?null:f/10-100:225<=(f=32767==f?NaN:f/100)&&(f=225-f),r.lidx<r.numData?void 0!==r.dataset?(r.dataset.push(f),r.laststat[r.lidx]=f,r.lidx++,r.processRecord()):console.log("Error: missing tag."):console.log("Error: data overlap?")}}return{nc:t,sg:a}},BrewChart.prototype.getXRange=function(){return void 0===this.chart?[0,0]:this.chart.xAxisRange()},BrewChart.prototype.setXRange=function(e){void 0!==this.chart&&this.chart.updateOptions({dateWindow:e})},BrewChart.prototype.desync=function(){void 0!==this.sync&&this.sync.detach()},BrewChart.prototype.synchronize=function(){this.sync=Dygraph.synchronize([this.chart,this.pchart],{selection:!0,zoom:!0,range:!1})},BrewChart.prototype.updateChart=function(){var e=this;void 0===e.chart?e.createChart():e.chart.updateOptions({file:e.data}),e.chart.setAnnotations(e.anno),e.psiAvail&&(void 0===e.pchart?(document.querySelectorAll(".pressure-group").forEach(function(e){e.style.visibility="visible"}),e.createPSIChart(),e.synchronize()):e.pchart.updateOptions({file:e.psi,dateWindow:[e.psi[0][0],e.psi[e.psi.length-1][0]]}))},BrewChart.prototype.processRecord=function(){for(var e=this;0==(1<<e.lidx&e.changes)&&e.lidx<e.numData;)e.dataset.push(e.lidx>RoomTemperatureIndex&&e.lidx!=PSIDataIndex?null:e.laststat[e.lidx]),e.lidx++;if(e.lidx>=e.numData){var t=e.dataset.slice(0,8),a=NaN,r=e.dataset[GravityLineIndex];if(e.calibrating)if(e.calculateSG||null==e.specificGravity){if(e.calculateSG&&null!=t[GravityLineIndex]){var i=this.celius?C2F(e.dataset[AuxTempLine]):e.dataset[AuxTempLine];a=e.sgByTilt(e.dataset[GravityLineIndex]),e.plato&&(a=BrewMath.sg2pla(BrewMath.tempCorrectionF(BrewMath.pla2sg(a),i,C2F(e.coTemp)))),t[GravityLineIndex]=a}}else a=e.specificGravity;else null!=r&&(a=r);isNaN(a)||(e.sg=a,e.filterSg=GravityFilter.add(a),e.plato?GravityTracker.add(Math.round(10*e.filterSg),e.ctime):GravityTracker.add(Math.round(1e3*e.filterSg),e.ctime)),isNaN(e.sg)?t.push(null):t.push(e.filterSg),isNaN(e.dataset[PSIDataIndex])||null==e.dataset[PSIDataIndex]||(e.psiAvail=!0);var n=null;if(!isNaN(e.dataset[PSIDataIndex])&&null!=e.dataset[PSIDataIndex]&&!isNaN(e.dataset[BeerTempLine])){var o=e.celius?C2F(e.dataset[BeerTempLine]):e.dataset[BeerTempLine];n=(e.dataset[PSIDataIndex]+14.695)*(.01821+.090115*Math.exp((32-o)/43.11))-.003342,n=Math.round(10*n)/10}e.psi.push([e.dataset[0],e.dataset[PSIDataIndex],e.targetPsi,n]),e.data.push(t),e.state.push(e.cstate),e.calibrating&&(e.angles.push(r),e.rawSG.push(e.specificGravity),e.specificGravity=null),e.incTime()}}</script><script>var PolyRegression={allpoints:[],clear:function(){for(var t=document.getElementById("pointlist").getElementsByTagName("tbody")[0],e=t.querySelectorAll("tr.pl_calpoint"),i=(e.length,e.length-1);0<=i;i--){var o=e[i];o.parentNode.removeChild(o)}return t},newrow:function(t){var e=this.row.cloneNode(!0);e.querySelector("td.pl_tilt").innerHTML=t[0].toFixed(2),e.querySelector("td.pl_sg").innerHTML=this.plato?t[1].toFixed(2):t[1].toFixed(4),e.querySelector("td.pl_value").innerHTML=this.plato?t[2].toFixed(2):t[2].toFixed(4),e.querySelector("td.pl_error").innerHTML=this.plato?t[3].toFixed(2):(1e3*t[3]).toFixed(1);var i=e.querySelector("input.pl_ignored_cb");i.checked=t[4];var o=this;return i.onchange=function(){o.igchanged(this)},e},igchanged:function(t){for(var e=document.getElementById("pointlist").getElementsByTagName("tbody")[0].querySelectorAll("input.pl_ignored_cb"),i=0,o=0,n=0;n<e.length;n++)e[n].checked?i|=1<<n:o++;o<2?(console.log("less than 2."),t.checked=!1):(this.cal_igmask=i,this.show())},show:function(){this.row||(this.row=Q("#pointlist tr.pl_calpoint"),this.row.parentNode.removeChild(this.row)),this.getFormula();for(var t=this.clear(),e=0;e<this.ptlist.length;e++)t.appendChild(this.newrow(this.ptlist[e]));this.chart()},getFormula:function(){var t=this;if(!(t.allpoints.length<2)){t.points=[];for(var e=0;e<t.allpoints.length;e++)1<<e&t.cal_igmask||t.points.push(t.allpoints[e]);t.points.length<2&&(t.points=t.alpoints,t.cal_igmask=0);var i=regression("polynomial",t.points,3<t.points.length?3:2<t.points.length?2:1,{precision:9});t.regression=i,Q("#polynormial").innerHTML=i.string,t.sgByTilt=3<t.points.length?function(t){return i.equation[0]+i.equation[1]*t+i.equation[2]*t*t+i.equation[3]*t*t*t}:2<t.points.length?function(t){return i.equation[0]+i.equation[1]*t+i.equation[2]*t*t}:function(t){return i.equation[0]+i.equation[1]*t};var o=[];for(e=0;e<t.allpoints.length;e++){var n=t.allpoints[e][0],l=t.allpoints[e][1],r=t.sgByTilt(n),a=l-r,s=0!=(1<<e&t.cal_igmask);o.push([n,l,r,a,s])}t.ptlist=o}},chart:function(){for(var t=[],e=0;e<this.allpoints.length;e++)t.push([this.ptlist[e][0],this.ptlist[e][1],this.ptlist[e][2]]);void 0===this.graph?this.graph=new Dygraph(document.getElementById("graph"),t,{labels:["Tilt","SG","Interpolated"],colors:["rgb(240, 100, 100)","rgb(89, 184, 255)"],series:{SG:{drawPoints:!0,pointSize:4,strokeWidth:0}},axisLabelFontSize:12,gridLineColor:"#ccc",gridLineWidth:"0.1px",strokeWidth:1,xRangePad:10,axes:{y:{axisLabelWidth:40,axisLabelFormatter:function(t){return t.toFixed(3)},valueFormatter:function(t){return t.toFixed(3)}},x:{pixelsPerLabel:30,axisLabelWidth:40}}}):(this.graph.updateOptions({file:t}),this.graph.resize())}};function applyIgnoreMask(){BChart.setIgnoredMask(PolyRegression.cal_igmask)}function openpolynomialpane(){Q("#polynomialpane").style.display="block",PolyRegression.allpoints=BChart.chart.calibrationPoints,PolyRegression.cal_igmask=BChart.chart.cal_igmask,PolyRegression.plato=BChart.chart.plato,PolyRegression.show()}function closepolynomialpane(){Q("#polynomialpane").style.display="none"}</script><script>function TabPane(e){var n=this;function s(e){var t=document.getElementById(e+"-m");t.className.indexOf("nav-selected")<0&&(t.className+=" nav-selected"),document.getElementById(e+"-s").style.display="block",n.cmode=e}n.cmode=null;for(var t=0;t<e.length;t++){var a=e[t];document.getElementById(a+"-s").style.display="none",document.getElementById(a+"-m").onclick=function(){var e,t,a,i=this.id.replace(/-m$/,"");return e=n.cmode,t=document.getElementById(e+"-m"),a=t.className.replace(/\snav-selected/,""),t.className=a,document.getElementById(e+"-s").style.display="none",s(i),!1}}s(e[0]),n.select=s}var Capper={target_psi:0,psi_valid:!1,hidepset:function(e){this.psi_valid=!e,Q(".psi-set-group").style.display=e?"none":"block"},setpsi:function(e){this.target_psi=e,Q("#cappressure").value=e},init:function(){var e=Q(".capping-info-pane");e&&(e.style.display="none");var t=Q("#capper-frame");t&&(t.style.display="none",this.initCtrl())},initCtrl:function(){var n=this;n.tabs=new TabPane(["tab-gravity","tab-time","tab-manual"]);var t=Q("#captimeinput");n.time=new Date,t.onchange=function(){var e=new Date(t.value);isNaN(e.getTime())?n.setInputTime(n.time):n.setInputTime(e)},Q("#cap-apply").onclick=function(){var e=n.psi_valid?"psi="+n.target_psi+"&":"",t=n.tabs.cmode;if("tab-gravity"==t){var a=Q("#capgravityinput").value;n.send(e+"sg="+a)}else if("tab-time"==t){var i=new Date(Q("#captimeinput").value);if(isNaN(i.getTime()))return void alert("Ora non valida");n.send(e+"at="+i.getTime()/1e3)}else Q("#capswitch").checked?n.send(e+"cap=1"):n.send(e+"cap=0")},n.hidepset(!0),Q("#cappressure").onchange=function(){n.target_psi=this.value}},send:function(e){console.log("send "+e),s_ajax({url:"cap?"+e,m:"GET",success:function(e){alert("Done!")},fail:function(e){alert("mancato inserimento valore tappatore")}})},setcap:function(e){Q("#capstate-open")&&(e?(Q("#capstate-open").style.display="none",Q("#capstate-close").style.display="inline-block"):(Q("#capstate-open").style.display="inline-block",Q("#capstate-close").style.display="none"))},setInputTime:function(e){this.time=e;var t=Q("#captimeinput");t.value="datetime-local"==t.type?formatDateForPicker(e):formatDate(e)},status:function(e){void 0!==e.m&&0!=e.m&&(this.statusInfo(e),this.updateCtrl(e))},statusInfo:function(e){var t=Q(".capping-info-pane");if(t){t.style.display="block",this.setcap(e.c);for(var a=["","cs-manopen","cs-mancap","cs-timecon","cs-sgcon"],i=1;i<a.length;i++)i==e.m?Q("#"+a[i]).style.display="inline-block":Q("#"+a[i]).style.display="none";void 0!==e.g&&(Q("#capgravityset").innerHTML=e.g),void 0!==e.t&&(Q("#captimeset").innerHTML=formatDate(new Date(1e3*e.t)))}},updateCtrl:function(e){var t=Q("#capper-frame");t&&(t.style.display="block",void 0!==e.g&&(Q("#capgravityinput").value=e.g),void 0!==e.t?this.setInputTime(new Date(1e3*e.t)):this.setInputTime(new Date),1==e.m?Q("#capswitch").checked=!1:2==e.m&&(Q("#capswitch").checked=!0),2==e.pm&&(this.hidepset(!1),this.setpsi(e.psi)))},tunit:"C",calpsi:function(){"undefined"!=typeof BrewPiSetting&&(this.tunit=BrewPiSetting.tempUnit),Q("#dlg_carbonation").style.display="block"},calCancel:function(){Q("#dlg_carbonation").style.display="none"},calOk:function(){var e=Q("#carcal-psi").innerHTML;isNaN(e)||this.setpsi(e),Q("#dlg_carbonation").style.display="none"},cal:function(){var e=Q("#carcal-vol").value,t=Q("#carcal-temp").value;"C"==this.tunit&&(t=C2F(t));var a=-16.6999-.0101059*t+.00116512*t*t+.173354*t*e+4.24267*e-.0684226*e*e;Q("#carcal-psi").innerHTML=Math.round(a)}}</script><script>var BPURL="/tschedule",MAX_STEP=7;function formatDate(e){var t=e.getHours(),i=e.getMinutes();function n(e){return e<10?"0"+e:e}return e.toLocaleDateString()+" "+n(t)+":"+n(i)}function formatDateForPicker(e){var t=e.getHours(),i=e.getMinutes();function n(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+n(e.getMonth()+1)+"-"+n(e.getDate())+"T"+n(t)+":"+n(i)}var profileEditor={dirty:!1,TU:"C",C_startday_Id:"#startdate",C_savebtn_Id:"savebtn",markdirty:function(e){this.dirty=e,document.getElementById(this.C_savebtn_Id).innerHTML=e?"Save*":"Save"},getStartDate:function(){return this.sd},setStartDate:function(e){this.sd=e;var t=Q(this.C_startday_Id);t.value="datetime-local"==t.type?formatDateForPicker(e):formatDate(e)},startDayChange:function(){var e=new Date(Q(this.C_startday_Id).value);isNaN(e.getTime())?this.setStartDate(this.sd):(this.sd=e,this.reorg(),this.markdirty(!0))},startnow:function(){var e=new Date;this.setStartDate(e),this.reorg(),this.markdirty(!0),ControlChart.update(this.chartdata())},rowList:function(){return document.getElementById("profile_t").getElementsByTagName("tbody")[0].getElementsByTagName("tr")},sgChange:function(e){!isNaN(e.innerHTML)||e.innerHTML.match(/^[\d]+%$/)||""==e.innerHTML?(e.saved=e.innerHTML,this.markdirty(!0)):e.innerHTML=e.saved},dayChange:function(e){""==e.innerHTML||isNaN(e.innerHTML)?e.innerHTML=e.saved:(this.markdirty(!0),this.reorg(),ControlChart.update(this.chartdata()))},tempChange:function(e){""==e.innerHTML||isNaN(e.innerHTML)?e.innerHTML=e.saved:(this.markdirty(!0),ControlChart.update(this.chartdata()))},stableChange:function(e){e.innerHTML.match(/^\s*(\d+)@(\d+)\s*$/)?(e.saved=e.innerHTML,this.markdirty(!0)):isNaN(e.innerHTML)?e.innerHTML=e.saved:(e.saved=parseInt(e.innerHTML),this.markdirty(!0))},initrow:function(e,t){var i=this,n=t.c;e.type=n;var r=e.getElementsByClassName("stage-temp")[0];"r"==n?r.innerHTML="":(r.innerHTML=t.t,r.contentEditable=!0,r.onblur=function(){i.tempChange(this)},r.onfocus=function(){this.saved=this.innerHTML});var a=e.getElementsByClassName("stage-time")[0];a.innerHTML=t.d,a.contentEditable=!0,a.onblur=function(){i.dayChange(this)},a.onfocus=function(){this.saved=this.innerHTML};var o=e.getElementsByClassName("stage-stabletime")[0],s=e.getElementsByClassName("stage-sg")[0];"r"==n?(s.innerHTML="",o.innerHTML=""):(s.saved=t.g,s.innerHTML=void 0===t.g?"":t.g,s.contentEditable=!0,s.onblur=function(){i.sgChange(this)},s.onfocus=function(){this.saved=this.innerHTML},void 0===t.s?o.innerHTML="":o.innerHTML=void 0===t.x?t.s:t.x+"@"+t.s,o.contentEditable=!0,o.onblur=function(){i.stableChange(this)},o.onfocus=function(){this.saved=this.innerHTML});var l=e.getElementsByClassName("for-time")[0],d=e.getElementsByClassName("condition")[0];"r"==n?(l.style.display="block",d.style.display="none"):(d.value=t.c,d.selectedIndex={t:0,g:1,a:3,s:2,o:4,u:5,v:6,b:7,x:8,w:9,e:10}[t.c],l.style.display="none",d.style.display="block")},datestr:function(e){return formatDate(new Date(this.sd.getTime()+1e3*Math.round(86400*e)))},reorg:function(){for(var e=this.rowList(),t=this.sd.getTime(),i=0;i<e.length;i++){var n=e[i];n.className=i%2?"odd":"even",n.getElementsByClassName("diaplay-time")[0].innerHTML=formatDate(new Date(t));var r=this.rowTime(n);t+=1e3*Math.round(86400*r)}},chartdata:function(){var e=this.rowList();if(0==e.length||void 0===this.sd)return[];var t=this.sd.getTime(),i=e[0],n=this.rowTemp(i),r=[];r.push([new Date(t),n]);for(var a=0;a<e.length;a++){var o;o="r"==(i=e[a]).type?this.rowTemp(e[a+1]):this.rowTemp(i),t+=1e3*Math.round(86400*this.rowTime(i)),r.push([new Date(t),o])}return r},addRow:function(){var e=document.getElementById("profile_t").getElementsByTagName("tbody")[0],t=e.getElementsByTagName("tr");if(t.length>=MAX_STEP)alert(" Troppi passi!");else{var i;if(0==t.length){i={c:"t",t:"C"==this.TU?20:68,d:1,g:1.01}}else{var n=t[t.length-1],r=this.row.cloneNode(!0);this.initrow(r,{c:"r",d:1}),e.appendChild(r),i={c:"t",t:this.rowTemp(n),d:1,g:""}}r=this.row.cloneNode(!0);this.initrow(r,i),e.appendChild(r),this.reorg(),this.markdirty(!0),ControlChart.update(this.chartdata())}},delRow:function(){var e=this.rowList();if(0!=e.length){var t=e[e.length-1];if(1<e.length){var i=e[e.length-2];i.parentNode.removeChild(i)}t.parentNode.removeChild(t),this.markdirty(!0),ControlChart.update(this.chartdata())}},rowTemp:function(e){return parseFloat(e.getElementsByClassName("stage-temp")[0].innerHTML)},rowCondition:function(e){return e.getElementsByClassName("condition")[0].value},rowTime:function(e){return parseFloat(e.getElementsByClassName("stage-time")[0].innerHTML)},rowSg:function(e){return e.getElementsByClassName("stage-sg")[0].saved},rowSt:function(e){var t=e.getElementsByClassName("stage-stabletime")[0].innerHTML;if("string"!=typeof t)return t;var i=t.match(/^\s*(\d+)@(\d+)\s*$/);return i?parseInt(i[2]):parseInt(t)},rowStsg:function(e){var t=e.getElementsByClassName("stage-stabletime")[0].innerHTML;if("string"!=typeof t)return!1;var i=t.match(/^\s*(\d+)@(\d+)\s*$/);return!!i&&parseInt(i[1])},renderRows:function(e){void 0===e.length&&console.log("error!");for(var t=document.getElementById("profile_t").getElementsByTagName("tbody")[0],i=0;i<e.length;i++){var n=this.row.cloneNode(!0);this.initrow(n,e[i]),t.appendChild(n)}this.reorg()},initable:function(e){if(this.row)this.clear();else{var t=document.getElementById("profile_t").getElementsByTagName("tbody")[0];this.row=t.getElementsByTagName("tr")[0],t.removeChild(this.row)}this.renderRows(e)},clear:function(){for(var e=this.rowList(),t=(e.length,e.length-1);0<=t;t--){var i=e[t];i.parentNode.removeChild(i)}this.markdirty(!0)},getProfile:function(){for(var e=this.rowList(),t=[],i=0;i<e.length;i++){var n=e[i],r=this.rowTime(n);if(isNaN(r))return!1;if("r"==n.type)t.push({c:"r",d:r});else{var a=this.rowTemp(n);if(isNaN(a))return!1;if(a>BrewPiSetting.maxDegree||a<BrewPiSetting.minDegree)return!1;var o=this.rowCondition(n),s={c:o,d:r,t:a},l=this.rowSg(n);if(0<="gaobxwe".indexOf(o)){if(""==l)return!1;s.g=l}var d=this.rowSt(n);if(0<="suvbxwe".indexOf(o)){if(isNaN(d))return!1;s.s=d;var c=this.rowStsg(n);c&&(s.x=c)}t.push(s)}}return{s:this.sd.toISOString(),v:2,u:this.TU,t:t}},convertUnit:function(e,t){if(t==this.TU)return e;for(var i=0;i<e.length;i++)e[i].t="F"==t?F2C(e[i].t):C2F(e[i].t);return e},loadProfile:function(e){this.sd=new Date(e.s),this.clear(),this.renderRows(this.convertUnit(e.t,e.u)),ControlChart.update(this.chartdata())},initProfile:function(e){if(void 0!==e){var t=new Date(e.s);this.setStartDate(t),this.initable(this.convertUnit(e.t,e.u))}else this.setStartDate(new Date),this.initable([])},setTempUnit:function(e){if(e!=this.TU){this.TU=e;for(var t=this.rowList(),i=0;i<t.length;i++){var n=t[i].querySelector("td.stage-temp"),r=parseFloat(n.innerHTML);isNaN(r)||(n.innerHTML="C"==e?F2C(r):C2F(r))}ControlChart.updateTU(e),ControlChart.update(this.chartdata())}}},PL={pl_path:"P",url_list:"/list",url_save:"/fputs",url_del:"/rm",url_load:"pl.php?ld=",div:"#profile-list-pane",shown:!1,initialized:!1,plist:[],path:function(e){return"/"+this.pl_path+"/"+e},depath:function(e){return e.substring(this.pl_path.length+1)},rm:function(t){var i=this,e="path="+i.path(i.plist[t]);s_ajax({url:i.url_del,m:"DELETE",data:e,success:function(e){i.plist.splice(t,1),i.list(i.plist)},fail:function(e){alert("fallito:"+e)}})},load:function(e){var t=this.path(this.plist[e]);s_ajax({url:t,m:"GET",success:function(e){var t=JSON.parse(e);profileEditor.loadProfile(t)},fail:function(e){}})},list:function(e){var n=this,r=Q(n.div).querySelector(".profile-list"),t=r.querySelectorAll("li");for(e=0;e<t.length;e++)r.removeChild(t[e]);var a=n.row;n.plist.forEach(function(e,t){var i=a.cloneNode(!0);i.querySelector(".profile-name").innerHTML=e,i.querySelector(".profile-name").onclick=function(e){return e.preventDefault(),n.load(t),!1},i.querySelector(".rmbutton").onclick=function(){n.rm(t)},r.appendChild(i)})},append:function(e){this.initialized&&(this.plist.push(e),this.list(this.plist))},init:function(){var t=this;t.initialized=!0,t.row=Q(t.div).querySelector("li"),t.row.parentNode.removeChild(t.row),s_ajax({url:t.url_list,m:"POST",data:"dir="+t.path(""),success:function(e){t.plist=[],JSON.parse(e).forEach(function(e){"file"==e.type&&t.plist.push(t.depath(e.name))}),t.list(t.plist)},fail:function(e){alert("fallito:"+e)}})},toggle:function(){this.initialized||this.init(),this.shown=!this.shown,this.shown?Q(this.div).style.display="block":Q(this.div).style.display="none"},saveas:function(){Q("#dlg_saveas").style.display="block"},cancelSave:function(){Q("#dlg_saveas").style.display="none"},doSave:function(){var t=Q("#dlg_saveas input").value;if(""!=t&&!t.match(/[\W]/g)){var e=profileEditor.getProfile();if(!1!==e){var i="path="+(n=this).path(t)+"&content="+encodeURIComponent(JSON.stringify(e)),n=this;s_ajax({url:n.url_save,m:"POST",data:i,success:function(e){n.append(t),n.cancelSave()},fail:function(e){alert("fallito:"+e)}})}else alert("Valore invalido. verifica")}}},BrewPiSetting={valid:!1,maxDegree:30,minDegree:0,tempUnit:"C"},ControlChart={unit:"C",init:function(e,t,i){var n=this;n.data=t,n.unit=i;n.chart=new Dygraph(document.getElementById(e),n.data,{colors:["rgb(89, 184, 255)"],axisLabelFontSize:12,gridLineColor:"#ccc",gridLineWidth:"0.1px",labels:["Ora","Temperatura"],labelsDiv:document.getElementById(e+"-label"),legend:"always",labelsDivStyles:{textAlign:"right"},strokeWidth:1,axes:{y:{valueFormatter:function(e){return e.toFixed(1)+"&deg;"+n.unit},pixelsPerLabel:20,axisLabelWidth:35},x:{axisLabelFormatter:function(e){d=new Date(e);var t=d.getYear()+1900,i=new RegExp("[^d]?"+t+"[^d]?");return d.toLocaleDateString().replace(i,"")},valueFormatter:function(e){return d=new Date(e),d.shortLocalizedString()},pixelsPerLabel:30,axisLabelWidth:40}},highlightCircleSize:2,highlightSeriesOpts:{strokeWidth:1.5,strokeBorderWidth:1,highlightCircleSize:5}})},update:function(e){0!=e.length&&(this.data=e,this.chart.updateOptions({file:this.data}))},updateTU:function(e){this.unit=e}},modekeeper={initiated:!1,modes:["profile","beer","fridge","off"],cmode:0,dselect:function(e){var t=document.getElementById(e+"-m"),i=document.getElementById(e+"-m").className.replace(/\snav-selected/,"");t.className=i,document.getElementById(e+"-s").style.display="none"},select:function(e){document.getElementById(e+"-m").className+=" nav-selected",document.getElementById(e+"-s").style.display="block"},init:function(){var t=this;if(!t.initiated){t.initiated=!0;for(var e=0;e<4;e++){var i=t.modes[e];document.getElementById(i+"-s").style.display="none",document.getElementById(i+"-m").onclick=function(){var e=this.id.replace(/-m/,"");return t.dselect(t.cmode),t.select(e),t.cmode=e,!1}}t.cmode="profile",t.select(t.cmode)}},apply:function(){if(BrewPiSetting.valid||alert("Not connesso al controller."),"beer"==this.cmode||"fridge"==this.cmode){var e=document.getElementById(this.cmode+"-t").value;if(""==e||isNaN(e)||e>BrewPiSetting.maxDegree||e<BrewPiSetting.minDegree)return void alert("Temperatura invalida:"+e);"beer"==this.cmode?BWF.send("j{mode:b, beerSet:"+e+"}"):(console.log("j{mode:f, fridgeSet:"+e+"}"),BWF.send("j{mode:f, fridgeSet:"+e+"}"))}else if("off"==this.cmode)BWF.send("j{mode:o}");else{if(profileEditor.dirty)return void alert("salva il profilo prima di applicare");document.getElementById("dlg_beerprofilereminder").style.display="block",document.getElementById("dlg_beerprofilereminder").querySelector("button.ok").onclick=function(){document.getElementById("dlg_beerprofilereminder").style.display="none";var e=parseFloat(Q("#dlg_beerprofilereminder input").value);"function"==typeof updateOriginGravity&&updateOriginGravity(e);var t={name:"webjs",og:1,gravity:e};s_ajax({url:"gravity",m:"POST",mime:"application/json",data:JSON.stringify(t),success:function(e){BWF.send("j{mode:p}")},fail:function(e){alert("fallito:"+e)}})},document.getElementById("dlg_beerprofilereminder").querySelector("button.oknog").onclick=function(){document.getElementById("dlg_beerprofilereminder").style.display="none",BWF.send("j{mode:p}")},document.getElementById("dlg_beerprofilereminder").querySelector("button.cancel").onclick=function(){document.getElementById("dlg_beerprofilereminder").style.display="none"}}}};function saveprofile(){var e=profileEditor.getProfile();if(!1!==e){var t=JSON.stringify(e);console.log("result="+t),s_ajax({url:BPURL,m:"POST",mime:"application/x-www-form-urlencoded",data:"data="+encodeURIComponent(t),success:function(e){profileEditor.markdirty(!1),alert("Done")},fail:function(e){alert("Salvataggio fallito.")}})}else alert("Valore invalido. verifica")}function updateTempUnit(e){for(var t=document.getElementsByClassName("t_unit"),i=0;i<t.length;i++)t[i].innerHTML=e}function ccparameter(e){var t={valid:!0,minDegree:e.tempSetMin,maxDegree:e.tempSetMax,tempUnit:e.tempFormat};t.tempUnit!=BrewPiSetting.tempUnit&&(updateTempUnit(t.tempUnit),profileEditor.setTempUnit(t.tempUnit)),BrewPiSetting=t}function rcvBeerProfile(e){closeDlgLoading(),updateTempUnit(e.u),BrewPiSetting.tempUnit=e.u,profileEditor.initProfile(e),ControlChart.init("tc_chart",profileEditor.chartdata(),e.u)}function initctrl_C(e){Capper.init(),modekeeper.init(),openDlgLoading()}function communicationError(){var e=Q(".error");e&&(e.innerHTML="Failed to connect to server.",e.style.display="block")}function initctrl(){getActiveNavItem(),Capper.init(),modekeeper.init(),PTC.init(Q("#ptc-control")),openDlgLoading(),BWF.init({onconnect:function(){BWF.send("c")},error:function(e){closeDlgLoading(),communicationError()},handlers:{A:function(e){void 0!==e.nn&&(Q("#hostname").innerHTML=e.nn),void 0!==e.ver&&(JSVERSION!=e.ver&&alert("Versione diversa!. Ricarica la pagina."),Q("#verinfo").innerHTML="v"+e.ver),void 0!==e.cap&&Capper.status(e.cap),void 0!==e.ptcs&&PTC.config(e.ptcs)},C:function(e){ccparameter(e)},B:rcvBeerProfile}})}</script><script>var T_CHART_REQUEST=12e3,T_CHART_RETRYTO=6e3,T_CHART_ZERODATA=1e4,T_CHART_REFRESH=2500,T_CHART_RETRY=1e4,T_LOAD_CHART=150,T_BWF_RECONNECT=1e4,T_BWF_LCD=1e4,BChart={offset:0,url:"chart.php",toggle:function(i,t){void 0!==t&&t?this.chart.togglePsiLine(i):this.chart.toggleLine(i)},updateFormula:function(){var i=this.chart.coefficients,t=this.chart.npt<<24|16777215&this.chart.cal_igmask,e=!0;if(void 0!==window.npt&&window.npt==t&&(e=!1),e){var n="coeff?a0="+i[0].toFixed(9)+"&a1="+i[1].toFixed(9)+"&a2="+i[2].toFixed(9)+"&a3="+i[3].toFixed(9)+"&pt="+t;s_ajax({url:n,m:"GET",success:function(i){window.npt=t},fail:function(i){alert("Impossibile aggiornare formula."+i)}})}},reprocesData:function(){for(var i=this,t=0;t<i.bdata.length;t++)i.chart.process(i.bdata[t])},updateChartResult:function(){var i=this;i.chart.sg&&!isNaN(i.chart.sg)&&(updateGravity(i.chart.sg),i.chart.sg=NaN,checkfgstate()),i.chart.updateChart()},setIgnoredMask:function(i){var t=this;t.chart.cal_igmask!=i&&(t.chart.calculateSG=!1,t.reprocesData(),t.chart.cal_igmask=i,t.chart.getFormula(),t.reprocesData(),t.updateChartResult(),t.chart.cal_igmask=i,t.updateFormula())},reqdata:function(){var n=this,i="offset="+n.offset;void 0!==n.startOff&&null!==n.startOff&&(i=i+"&index="+n.startOff);var o=new XMLHttpRequest;o.open("GET",n.url+"?"+i),o.timeout=T_CHART_REQUEST,o.responseType="arraybuffer",o.onload=function(i){if(404!=this.status){var t=new Uint8Array(this.response);if(n.offset?n.bdata.push(t):n.bdata=[t],0==t.length)return n.timer&&clearInterval(n.timer),n.timer=null,void setTimeout(function(){n.reqdata()},T_CHART_ZERODATA);var e=n.chart.process(t);if(e.nc)n.offset=t.length,n.startOff=o.getResponseHeader("LogOffset"),n.chart.calibrating&&(n.chart.getFormula(),n.chart.process(t),n.chart.calculateSG&&(Q("#formula-btn").style.display="block",n.updateFormula()));else if(n.offset+=t.length,n.chart.calibrating&&e.sg)return console.log("New SG availbe. reprocess"),n.chart.calculateSG=!1,n.reprocesData(),n.chart.getFormula(),n.reprocesData(),n.updateChartResult(),void n.updateFormula();n.chart.updateChart(),isNaN(n.chart.og)||(updateOriginGravity(n.chart.og),n.chart.og=NaN),n.chart.sg&&!isNaN(n.chart.sg)&&(updateGravity(n.chart.sg),n.chart.sg=NaN,checkfgstate()),null==n.timer&&n.settimer()}else console.log(" Error getting log data")},o.ontimeout=function(i){console.error("Timeout!"+new Date),null==n.timer&&setTimeout(function(){n.reqdata()},T_CHART_RETRYTO)},o.onerror=function(){console.log("Error getting data"),null==n.timer&&setTimeout(function(){n.reqdata()},T_CHART_RETRY)},o.send()},settimer:function(){var i=this;i.timer=setInterval(function(){i.reqdata()},1e3*i.chart.interval)},init:function(i,t,e,n,o,r){this.chart=new BrewChart(i),this.chart.setLabels(t,e),void 0!==n&&this.chart.setPChart(n,o,r)},timer:null,start:function(){this.running||(this.running=!0,this.offset=0,this.reqdata())},reqnow:function(){var i=this;i.timer&&clearInterval(i.timer),i.timer=null,i.reqdata()}};function parseStatusLine(i){var t={},e=0,n=[/Idling\s+for\s+(\S+)\s*$/i,/control\s+OFF/i,/Door\s+Open/i,/Heating\s+for\s+(\S+)\s*$/i,/Cooling\s+for\s+(\S+)\s*$/i,/Wait\s+to\s+Cool\s+(\S+)\s*$/i,/Wait\s+to\s+Heat\s+(\S+)\s*$/i,/Waiting\s+for\s+Peak/i,/Cool\s+Time\s+left\s+(\S+)\s*$/i,/Heat\s+Time\s+left\s+(\S+)\s*$/i];for(t.ControlStateSince="",e=0;e<n.length;e++){var o=n[e].exec(i);if(o){void 0!==o[1]&&(t.ControlStateSince=o[1]);break}}return t.ControlState=e,t.StatusLine=i,t}function renderLcdText(t){var i=Q(".error");function e(i){return i<-1e4?"--.-":(i/100).toFixed(1)+"&deg;"+t.tu}i&&(i.style.display="none");var n=parseStatusLine(t.sl);n.ControlMode=t.md,n.unit=t.tu,n.BeerTemp=e(t.bt),n.BeerSet=e(t.bs),n.FridgeTemp=e(t.ft),n.FridgeSet=e(t.fs),n.RoomTemp=e(t.rt);var o={o:"OFF",b:"Costanti birra",f:"Costanti frigo",p:"Profilo birra",i:"Invalid"},r=["Inattivo da {time}","Temp. Control Off","Porta aperta","Riscaldando da {time}","Raffredando da {time}","In attesa di raffredare {time}","In attesa di riscaldare {time}","In attesa del Picco","Tempo di raffredamento rimanente {time}","Tempo di riscaldamento rimanente {time}","Stato invalido"];if(Object.keys(n).map(function(i,t){var e=Q("#lcd"+i);e&&(e.innerHTML="ControlMode"==i?o[n[i]]:"ControlState"==i?function(i,t){if(void 0===t)return r[i];var e,n="";return(e=/(\d+)h(\d\d)m(\d\d)/.exec(t))?n="{HH}h{MM}m{SS}".replace("{SS}",e[3]).replace("{MM}",e[2]).replace("{HH}",e[1]):(e=/(\d+)m(\d\d)/.exec(t))&&(n="{MM}m{SS}".replace("{SS}",e[2]).replace("{MM}",e[1])),r[i].replace("{time}",n)}(n[i],n.ControlStateSince):n[i])}),void 0!==n.unit&&(window.tempUnit=n.unit),void 0!==n.BeerTemp){var a=/([\d\.]+)/.exec(n.BeerTemp);0<a.length&&(window.beerTemp=a[0])}}var roomOfridge=!1;function simLcd(i){function t(i){if(i<-1e4)return" --.-";for(var t=(i/100).toFixed(1),e="",n=t.length;n<5;n++)e+=" ";return e+t}var e=[];return e[0]="Mode   "+{o:"Off",b:"Beer Const.",f:"Fridge Const.",p:"Beer Profile",i:"Invalid"}[i.md],e[1]="Beer  "+t(i.bt)+" "+t(i.bs)+" &deg;"+i.tu,-1e4<i.rt&&roomOfridge?e[2]="Room  "+t(i.rt)+" "+t(-2e4)+" &deg;"+i.tu:e[2]="Fridge"+t(i.ft)+" "+t(i.fs)+" &deg;"+i.tu,roomOfridge=!roomOfridge,e[3]=i.sl,e}function displayLcdText(i){for(var t=0;t<4;t++){var e=document.getElementById("lcd-line-"+t);e&&(e.innerHTML=i[t])}}function displayLcd(i){window.tempUnit=i.tu,displayLcdText(simLcd(i)),renderLcdText(i)}function hideErrorMsgs(){for(var i=document.querySelectorAll(".errormsg"),t=0;t<i.length;t++)i[t].style.display="none"}function communicationError(){var i=Q(".error");i?(hideErrorMsgs(),Q("#error_connect").style.display="block",i.style.display="block"):displayLcdText(["Failed to","connect to","Server",""])}function controllerError(){var i=Q(".error");i?(hideErrorMsgs(),Q("#error_noupdate").style.display="block",i.style.display="block"):displayLcdText(["Controller not","updating data","...",""])}function checkTime(i,t){var e=new Date,n=0-60*e.getTimezoneOffset(),o=Math.round(e.getTime()/1e3);(t!=n||1800<Math.abs(o-i))&&s_ajax({url:"time",m:"POST",mime:"application/x-www-form-urlencoded",data:"time="+o+"&off="+n,success:function(){}})}function gravityDevice(i){if(void 0!==i.plato&&(window.plato=i.plato,window.plato&&showPlatoUnit()),void 0!==i.fpt&&(window.npt=i.fpt),void 0!==i.name)if(void 0!==i.lu){i.name.startsWith("iSpindel")&&void 0===window.iSpindel&&(window.iSpindel=!0,Q("#iSpindel-pane")&&(Q("#iSpindel-pane").style.display="block"));var t,e=Q("#iSpindel-name");e&&(e.innerHTML=i.name),void 0!==i.battery&&Q("#iSpindel-battery")&&(Q("#iSpindel-battery").innerHTML=i.battery),t=void 0!==i.lu?new Date(1e3*i.lu):new Date,Q("#iSpindel-last")&&(Q("#iSpindel-last").innerHTML=t.shortLocalizedString()),!BChart.chart.calibrating&&void 0!==i.sg&&0<i.sg&&updateGravity(i.sg),void 0!==i.angle&&Q("#iSpindel-tilt")&&(Q("#iSpindel-tilt").innerHTML=""+i.angle),void 0!==i.rssi&&Q("#ispindel-rssi")&&(Q("#ispindel-rssi").classList.remove("no-display"),wifibar("#ispindel-rssi",i.rssi)),void 0!==i.lpf&&GravityFilter.setBeta(i.lpf),void 0!==i.stpt&&GravityTracker.setThreshold(i.stpt),void 0!==i.ctemp&&(window.caltemp=i.ctemp)}else console.log("iSpindel:"+JSON.stringify(i))}function updateGravity(i){window.sg=i,Q("#gravity-sg").innerHTML=window.plato?i.toFixed(1):i.toFixed(3),void 0!==window.og&&(Q("#gravity-att").innerHTML=window.plato?BrewMath.attP(window.og,i):BrewMath.att(window.og,i),Q("#gravity-abv").innerHTML=window.plato?BrewMath.abvP(window.og,i):BrewMath.abv(window.og,i))}function updateOriginGravity(i){void 0!==window.og&&window.og==i||(window.og=i,Q("#gravity-og").innerHTML=window.plato?i.toFixed(1):i.toFixed(3),void 0!==window.sg&&updateGravity(window.sg))}function showgravitydlg(i){if(Q("#dlg_addgravity .og").style.display="none",Q("#dlg_addgravity .sg").style.display="none",Q("#dlg_addgravity ."+i).style.display="block",Q("#dlg_addgravity").style.display="block",void 0!==window.tempUnit){window.celsius=!1;var t=68;/C$/.test(window.tempUnit)&&(window.celsius=!0,t=20),Q("#dlg_addgravity .tempinput").value=t;for(var e=document.querySelectorAll("#dlg_addgravity .temp-unit"),n=0;n<e.length;n++)e[n].innerHTML=window.tempUnit}else window.celsius=!0}function dismissgravity(){Q("#dlg_addgravity").style.display="none"}function inputsg_change(){var i=parseFloat(Q("#dlg_addgravity .sginput").value),t=parseFloat(Q("#dlg_addgravity .tempinput").value);if(!isNaN(i)&&!isNaN(t)){var e=void 0!==window.caltemp?window.caltemp:20;if(e=window.celsius?e:C2F(e),Q("#sginput-hm-cal-temp").innerHTML=e,window.plato){var n=BrewMath.pTempCorrection(window.celsius,i,t,e);Q("#sginput-hmc").innerHTML=n.toFixed(2)}else{n=BrewMath.tempCorrection(window.celsius,i,t,e);Q("#sginput-hmc").innerHTML=n.toFixed(3)}if(void 0!==window.beerTemp)if(Q("#sginput-ispindel-temp").innerHTML=window.beerTemp,window.plato){var o=BrewMath.pTempCorrection(window.celsius,i,t,window.beerTemp);Q("#sginput-sg-ispindel").innerHTML=o.toFixed(2)}else{o=BrewMath.tempCorrection(window.celsius,i,t,window.beerTemp);Q("#sginput-sg-ispindel").innerHTML=o.toFixed(3)}}}function inputgravity(){var i=parseFloat(Q("#sginput-hmc").innerHTML);if(window.plato||!(i<.8||1.25<i)){dismissgravity(),openDlgLoading(),window.isog?updateOriginGravity(i):updateGravity(i);var t={name:"webjs",gravity:i};window.isog&&(t.og=1),window.plato&&(t.plato=1),s_ajax({url:"gravity",m:"POST",mime:"application/json",data:JSON.stringify(t),success:function(i){closeDlgLoading(),setTimeout(function(){BChart.chart.calibrating&&BChart.reqnow()},T_CHART_REFRESH)},fail:function(i){alert("fallito:"+i),closeDlgLoading()}})}}function inputSG(){window.isog=!1,showgravitydlg("sg")}function inputOG(){window.isog=!0,showgravitydlg("og")}function wifibar(i,t){for(var e=[-1e3,-90,-80,-70,-67],n=4;0<=n&&!(e[n]<t);n--);for(var o=Q(i).getElementsByClassName("rssi-bar"),r=0;r<o.length;r++)o[r].style.backgroundColor=r<n?window.rssiBarColor:"rgba(255,255,255,0.05)";Q(i).title=0<t?"?":Math.min(Math.max(2*(t+100),0),100)}function displayrssi(i){Q("#rssi").title=0<i?"?":Math.min(Math.max(2*(i+100),0),100),wifibar("#rssi",i),Q("#wifisignal")&&(Q("#wifisignal").innerHTML=0<i?"?":Math.min(Math.max(2*(i+100),0),100))}function initRssi(){var i=Q("#rssi");window.rssiBarColor=window.getComputedStyle(Q(".rssi-bar1")).getPropertyValue("background-color"),Q("#wifisignal")&&(i.onmouseover=function(){Q("#wifisignal").style.display="block"},i.onmouseout=function(){Q("#wifisignal").style.display="none"})}function ptcshow(i){if(void 0!==i.ptc&&void 0!==i.pt){var t=i.ptc,e=i.pt,n=Q("#ptc-pane");if(n){n.style.display="o"==t?"none":"block";var o=Q("#ptc-state");o&&(o.style.backgroundColor="c"==t?"lightgreen":"gray");var r=Q("#ptc-state-idle");if(r){var a=Q("#ptc-state-run");"c"==t?(r.style.display="none",a.style.display="block"):(r.style.display="block",a.style.display="none")}var s,l,d,c=Q("#ptc-time");if(c&&(c.innerHTML=(s=e,l=Math.floor(s/3600),d=Math.floor((s-3600*l)/60),(l?l+"H":"")+(l+d?d+"M":"")+(s-3600*l-60*d)+"S")),void 0!==i.ptctp){var p=Q("#ptc-temp");p&&(p.innerHTML=i.ptctp<-100?"NA":i.ptctp/100+"&deg;C")}if(void 0!==i.ptclo&&void 0!==i.ptcup){var g=Q("#ptc-set");g&&(g.innerHTML=i.ptclo/100+" ~ "+i.ptcup/100+"&deg;C")}}}}function showPlatoUnit(){for(var i=document.querySelectorAll(".platounit"),t=0;t<i.length;t++)i[t].style.display="inline-block"}function BPLMsg(i){BWF.gotMsg=!0,void 0!==i.rssi&&displayrssi(i.rssi),void 0!==i.sl&&displayLcd(i),void 0!==i.reload&&(console.log("Forced reload chart"),BChart.reqnow(),Q("#recording").innerHTML&&Q("#recording").innerHTML==i.log||(window.npt=0)),void 0!==i.nn&&(Q("#hostname").innerHTML=i.nn,document.title=i.nn),void 0!==i.ver&&(JSVERSION!=i.ver&&alert("Versione diversa!. Ricarica la pagina."),Q("#verinfo").innerHTML="v"+i.ver),void 0!==i.tm&&void 0!==i.off&&checkTime(i.tm,i.off),void 0!==i.log&&(Q("#recording").innerHTML=i.log),void 0!==i.cap&&Capper.status(i.cap),void 0!==i.plato&&(window.plato=i.plato,window.plato&&showPlatoUnit()),void 0!==i.pm&&void 0!==i.psi&&0!=i.pm&&(Q("#pressure-info-pane").style.display="block",Q("#pressure-psi").innerHTML=i.psi),ptcshow(i)}function connBWF(){BWF.init({onconnect:function(){BWF.send("c"),window.lcdTimer&&clearInterval(window.lcdTimer),window.lcdTimer=setInterval(function(){if(!BWF.gotMsg){if(window.rcTimeout){if(BWF.rcCount++,console.log("rcTimeout failed."),BWF.rcCount<3)return;clearTimer(window.rcTimeout)}return controllerError(),window.rcTimeout=setTimeout(function(){window.rcTimeout=null,BWF.gotMsg||BWF.reconnect(!0)},T_BWF_RECONNECT),void(BWF.rcCount=0)}BWF.gotMsg=!1},T_BWF_LCD)},error:function(i){communicationError(),closeDlgLoading()},handlers:{A:BPLMsg,G:function(i){gravityDevice(i)},C:function(i){"undefined"!=typeof ccparameter&&ccparameter(i)},B:function(i){"undefined"!=typeof rcvBeerProfile&&rcvBeerProfile(i)}}})}function init_classic(){window.plato=!1,BChart.init("div_g",Q("#ylabel").innerHTML,Q("#y2label").innerHTML),initRssi(),Capper.init(),BWF.gotMsg=!0,initctrl_C(),connBWF(),setTimeout(function(){BChart.start()},T_LOAD_CHART)}function init(){Q("#pressure-info-pane").style.display="none",window.plato=!1,BChart.init("div_g",Q("#ylabel").innerHTML,Q("#y2label").innerHTML,"div_p",Q("#psilabel").innerHTML,Q("#vollabel").innerHTML),initRssi(),Capper.init(),BWF.gotMsg=!0,connBWF(),setTimeout(function(){BChart.start()},T_LOAD_CHART),getActiveNavItem()}</script><style>.lcddisplay{width:280px;height:90px;float:left;margin:5px;background:#000;background:-moz-linear-gradient(top,#000 2%,#2b2b2b 11%,#212121 54%,#212121 92%,#000 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(2%,#000),color-stop(11%,#2b2b2b),color-stop(54%,#212121),color-stop(92%,#212121),color-stop(100%,#000));background:-webkit-linear-gradient(top,#000 2%,#2b2b2b 11%,#212121 54%,#212121 92%,#000 100%);background:-o-linear-gradient(top,#000 2%,#2b2b2b 11%,#212121 54%,#212121 92%,#000 100%);background:-ms-linear-gradient(top,#000 2%,#2b2b2b 11%,#212121 54%,#212121 92%,#000 100%);background:linear-gradient(top,#000 2%,#2b2b2b 11%,#212121 54%,#212121 92%,#000 100%);-webkit-box-shadow:inset 1px 1px 5px #333;-moz-box-shadow:inset 1px 1px 5px #333;box-shadow:inset 1px 1px 5px #333;border:2px solid #333;-webkit-border-radius:2px;-moz-border-radius:2px;border-radius:2px}.lcddisplay .lcd-text{float:left;margin:5px 16px}.lcd-line{float:left;clear:left;font-size:16px;font-weight:400;font-style:normal;font-family:"Courier New",Courier,monospace;color:#ff0;white-space:pre}.chart-legend-row .toggle{width:8px;height:8px;border-radius:5px;float:left;margin:2px 0 0 0;cursor:pointer;border:1px solid}.chart-legend{font-family:Lucida Grande,Lucida Sans,Arial,sans-serif;font-size:11px;margin:10px 0 0 0;border:solid 1px #777;border-radius:5px;float:right;width:155px}.chart-legend-row{padding:8px 5px 8px 5px}.legend-label{float:left;padding:0 5px 0 5px;cursor:pointer}.legend-value{float:right}.chart-legend-row.time{background-color:#def}#div_lb{display:none}#div_g{float:left;width:800px;height:390px}#chart-container{width:965px;height:410px;padding:5px 5px 5px 5px}.hide{display:none}.frame{border-radius:5px;margin:5px 5px 5px 5px;border:solid 1px #304d75;width:975px}#top-frame{height:520px}#bottom-frame{height:380px}#topbar{width:965px;height:108px;background-color:#5c9ccc;padding:5px 5px 5px 5px}#menu{float:right}#banner{font-size:18pt;float:left;color:#fff;margin-top:20px;margin-left:20px}#recording{color:#add8e6;font-size:18px;font-family:serif}#top-frame button{float:right;width:200px;margin-top:3px}.navbar{margin:0;padding:.2em .2em 0;border:1px solid #4297d7;background:#5c9ccc;color:#fff;height:4em;display:block;position:relative;width:968px}#set-mode-text{margin-left:2px;float:left;margin:.2em}.navitem{background:#dfeffc;font-weight:700;color:#2e6e9e;margin:.2em .2em 0 0;padding:.5em;border-top-right-radius:5px;border-top-left-radius:5px}.nav-selected{background:#fff;font-weight:700;color:#e17009;margin:.2em .2em 0 0;padding:.5em .5em .75em .5em}.navitems{display:block;margin-top:2em}#apply{background:#dfeffc;font-weight:700;color:#2e6e9e;margin:.2em .1em 0 0;padding:.5em}.tab-containter{margin:.5em;width:965px}.profileTable td,th{padding:3px;text-align:center}.profileTable tbody TR.odd{background:#f7f7f7}.profileTable tbody TR.even{width:100%}.profileTable TH{border:1px solid #4297d7;background:#5c9ccc;color:#fff;font-weight:700}table.profileTable{width:100%}#bottom-frame button{color:#1d5987;background:#dfeffc;font-weight:700;border-radius:6px;margin:4px}#addbutton{float:right;width:120px}#clearbtn{width:18%}#savebtn{width:25%;float:right}#delbtn{width:18%}.modal{display:none;position:fixed;z-index:100;padding-top:20px;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:auto;padding:10px;border:1px solid #888;width:340px;height:220px;border-radius:8px}#dlg_addgravity button{float:right;width:56px;margin-top:2px}.dialog-buttons{float:center}#modekeeper-apply{margin-top:0}#profile-edit{float:left;margin:6px;width:510px;position:relative}#tc_chart{width:430px;height:280px;float:right;margin:6px}.info-pane table{width:92px;float:right;border:1px solid #fff;border-radius:5px;margin-right:4px;color:#0ff;font-size:12px}.hidden-pane{display:none}#profile-list-pane .modal-content{height:360px;width:240px;overflow:scroll}#profile-list-pane{border-style:outset;border:solid 3px;overflow:auto}#profile-list-pane li{white-space:nowrap;overflow:hidden}#profile-list-pane .rmbutton{color:red}#profile-list-pane a,#profile-list-pane u{text-decoration:none}.small-led{width:10px;height:10px;border-radius:6px;border:0}#fgstate{margin:4px 0 0 0;float:right}#rssi{float:right;position:relative;margin:0 16px 0 0;height:16px;width:12px;display:inline-block}#wifisignal{font-size:12pt;color:#000;font-family:Courier New,Courier,monospace;position:absolute;top:2px;left:2px;display:none}.rssi-bar{position:absolute;bottom:0;float:left;width:4px;border-radius:1px;background-color:#fff}.rssi-bar1{height:4px;left:0}.rssi-bar2{height:8px;left:6px}.rssi-bar3{height:12px;left:12px}.rssi-bar4{height:16px;left:18px}#verinfo{display:inline-block;font-size:8pt;color:#fff}#pointlist,#pointlist td,#pointlist th,#pointlist tr{border:1px solid;border-collapse:collapse}#pointlist th{width:52px;background-color:#ffff27}#pointlist td{text-align:right}#graph{width:500px;height:500px}#formula-btn{font-style:italic;float:right;display:none}#polynomialpane .modal-content{width:800px;height:600px;position:relative}#xclose{position:absolute;color:red;background-color:#d3d3d3;width:20px;height:20px;right:0;text-align:center;cursor:pointer}#gravity-og,#gravity-sg{cursor:pointer}.platounit{display:none}</style></head><body onload=init_classic()><div style=display:none><span id=ylabel>Temperatura</span><span id=y2label>Densità</span></div><div class=frame id=top-frame><div id=topbar><div id=lcd class=lcddisplay><span class=lcd-text><span class=lcd-line id=lcd-line-0> Live LCD in attesa</span><span class=lcd-line id=lcd-line-1> per aggiornamenti da</span><span class=lcd-line id=lcd-line-2> script...</span><span class=lcd-line id=lcd-line-3> </span><p></p><p></p></span></div><div id=banner><div id=hostname>BrewPiLess</div><div id=recording></div></div><div id=menu><div id=versionsignal><div id=verinfo>v2</div><div id=rssi><div class="rssi-bar rssi-bar1"></div><div class="rssi-bar rssi-bar2"></div><div class="rssi-bar rssi-bar3"></div><div class="rssi-bar rssi-bar4"></div><div id=wifisignal>?</div></div></div><button onclick='window.open("/log")'>Log dati</button><br><button onclick='window.open("/setup.htm")'>Setup dispositivo</button><br><button onclick='window.open("/config")'>Configurazione sistema</button><br><button onclick='window.open("/gdc")'>Rilevamento densità</button></div><div id=gravity-pane class=info-pane><table><tr><th> OG: </th><td><span id=gravity-og onclick=inputOG()>--</span> <span class=platounit>&deg;P</span></td></tr><tr><th> SG: </th><td><span id=gravity-sg onclick=inputSG()>--</span> <span class=platounit>&deg;P</span><div id=fgstate class=small-led></div></td></tr><tr><th> ATT: </th><td><span id=gravity-att>--</span>%</td></tr><tr><th> ABV: </th><td><span id=gravity-abv>--</span>%</td></tr></table></div><div id=iSpindel-pane class="info-pane hidden-pane"><table><tr><th colspan=2><span id=iSpindel-name></span></th></tr><tr><th> Batteria: </th><td><span id=iSpindel-battery>--</span></td></tr><tr><th> Angolo: </th><td><span id=iSpindel-tilt></span></td></tr><tr><td colspan=2 align=center>@<span id=iSpindel-last>--</span></td></tr></table></div><div id=ptc-pane class="info-pane hidden-pane"><table><tr><th> PTC </th><td><div id=ptc-state class=small-led></div></td></tr><tr><th> TEMP </th><td><div id=ptc-temp>11 &deg;C</div></td></tr><tr><td colspan=2 align=center><span id=ptc-set></span></td></tr><tr><td colspan=2 align=center><span id=ptc-time>100H59M32S</span></td></tr></table></div></div><div id=chart-container><div id=div_g></div><div id=chart-legend class=chart-legend><div class="chart-legend-row time"><div class=beer-chart-legend-time> Data / Ora </div></div><div class="chart-legend-row beer-temp"><div class="toggle beer-temp" onclick=BChart.toggle(BeerTempLine)></div><div class=legend-label onclick=BChart.toggle(BeerTempLine)> Temp. Birra </div><div class=legend-value>--</div><br></div><div class="chart-legend-row beer-set"><div class="toggle beer-set" onclick=BChart.toggle(BeerSetLine)></div><div class=legend-label onclick=BChart.toggle(BeerSetLine)> Imp. Birra </div><div class=legend-value>--</div><br></div><div class="chart-legend-row fridge-temp"><div class="toggle fridge-temp" onclick=BChart.toggle(FridgeTempLine)></div><div class=legend-label onclick=BChart.toggle(FridgeTempLine)> Temp. Frigo </div><div class=legend-value>--</div><br></div><div class="chart-legend-row fridge-set"><div class="toggle fridge-set" onclick=BChart.toggle(FridgeSetLine)></div><div class=legend-label onclick=BChart.toggle(FridgeSetLine)> Imp. Frigo </div><div class=legend-value>--</div><br></div><div class="chart-legend-row room-temp"><div class="toggle room-temp" onclick=BChart.toggle(RoomTempLine)></div><div class=legend-label onclick=BChart.toggle(RoomTempLine)> Temp. ambiente </div><div class=legend-value>--</div><br></div><div class="chart-legend-row aux-temp"><div class="toggle aux-temp" onclick=BChart.toggle(AuxTempLine)></div><div class=legend-label onclick=BChart.toggle(AuxTempLine)> Temp. Aux </div><div class=legend-value>--</div><br></div><div class="chart-legend-row gravity"><div class="toggle gravity" onclick=BChart.toggle(GravityLine)></div><div class=legend-label onclick=BChart.toggle(GravityLine)> Densità </div><div class=legend-value>--</div><br></div><div class="chart-legend-row filtersg"><div class="toggle filtersg" onclick=BChart.toggle(FilteredSgLine)></div><div class=legend-label onclick=BChart.toggle(FilteredSgLine)> SG filtrata </div><div class=legend-value>--</div><br></div><div class="chart-legend-row state"><div class=beer-chart-state> stato </div><br></div><div class=chart-legend-row id=formula-btn onclick=openpolynomialpane()><div class=legend-label>f</div><br></div></div></div></div><div class=frame id=bottom-frame><div class=navbar id=header><div id=set-mode-text> Imp. modalità temperatura: </div><div class=navitems><span class=navitem id=profile-m>Profilo Birra</span><span class=navitem id=beer-m>Const. Birra</span><span class=navitem id=fridge-m>Const. Frigo</span><span class=navitem id=off-m>Spento</span><button id=modekeeper-apply onclick=modekeeper.apply()>Applica</button></div></div><div class=tab-containter><div id=profile-s class=detail><div id=profile-edit><div><div><span>Data inizio:</span><input type=text size=16 id=startdate onchange=profileEditor.startDayChange()> <button id=setnow onclick=profileEditor.startnow()>Adesso</button> <button id=addbutton onclick=profileEditor.addRow()>Aggiungi</button></div></div><table class=profileTable id=profile_t><thead><tr><th>&deg;<span class=t_unit>C</span></th><th> Condizioni </th><th> Giorni </th><th> SG </th><th> Stabile </th><th> Inizio ora </th></tr></thead><tbody><tr><td class=stage-temp>19</td><td><div class=for-time> Rampa </div><div class=condition-con><select class=condition><option value=t>Ora</option><option value=g>SG</option><option value=s>Stabile</option><option value=a>Ora & SG</option><option value=o>Ora o SG</option><option value=u>Ora o Stabile</option><option value=v>Ora & Stabile</option><option value=b>SG o Stabile</option><option value=x>SG & Stabile</option><option value=w>Tutte</option><option value=e>o</option></select></div></td><td class=stage-time>7</td><td class=stage-sg></td><td class=stage-stabletime></td><td class=diaplay-time></td></tr></tbody></table><div><button id=delbtn onclick=profileEditor.delRow()>Cancella</button> <button id=clearbtn onclick=profileEditor.clear()>Pulisci</button> <button id=loadbtn onclick=PL.toggle()>Carica</button> <button id=saveasbtn onclick=PL.saveas()>Salva come</button> <button id=savebtn onclick=saveprofile()>Salva</button></div></div><div id=tc_chart></div></div><div id=beer-s class=detail> Imposta temperatura  birra: <input type=text size=6 id=beer-t>&deg;<span class=t_unit>C</span></div><div id=fridge-s class=detail> Imposta temperatura frigo: <input type=text size=6 id=fridge-t>&deg;<span class=t_unit>C</span></div><div id=off-s class=detail> Dissativa controllo temperatura. </div></div></div><div class="frame capping-info-pane" id=capper-frame><div class=navbar id=cap-header class=captimeset><div id=set-mode-text class=capping-info-pane><span>Stato limitazione pressione (Spunding):</span><span id=capstate-open class=capstate>Aperto</span><span id=capstate-close class=capstate>Limitazione pressione (Spunding)</span>@ <span id=cs-sgcon class=capstate>gravity &lt;= <span id=capgravityset></span></span> <span id=cs-timecon class=capstate><span id=captimeset></span></span> <span id=cs-mancap class=capstate>Limitazione pressione manuale</span><span id=cs-manopen class=capstate>Apertura manuale</span></div><div class=navitems><span class=navitem id=tab-gravity-m>Densità</span><span class=navitem id=tab-time-m>Ora</span><span class=navitem id=tab-manual-m>Manuale</span><button id=cap-apply>Applica</button></div></div><div class=tab-containter><div id=tab-gravity-s class=detail><span>Tappa quando densità e inferiore a</span><input type=text size=6 id=capgravityinput></div><div id=tab-time-s class=detail><span>Tappa dopo</span><input type=text size=20 id=captimeinput></div><div id=tab-manual-s class=detail><span>Limitazione pressione (Spunding)</span><input type=checkbox checked id=capswitch></div></div><div class=psi-set-group><input type=number step=1 size=6 id=cappressure style=max-width:60px;margin:16px;display:inline>psi <button class=btn onclick=Capper.calpsi()>...</button></div></div><div id=dlg_beerprofilereminder class=modal><div class=modal-content> <p>Note:</p> <p>Per far funzionare corretamente il profilo birra,</p> <p> <strong> la densità OG deve essere specificata </strong> se SG e specificata in percentuale(%), e <strong> il logging deve essere attivato </strong> se viene utilizzata la lettura densità stabile. </p> Densità OG: <input type=text size=6><div class=dialog-buttons><button class=oknog>OK, inizia</button> <button class=ok>Imposta OG, e inizia</button> <button class=cancel>Cancella</button></div></div></div><div id=dlg_loading class=modal><div class=modal-content><p> Connessione al controller BrewPiLess ... </p></div></div><div id=dlg_addgravity class=modal><div class=modal-content><span class="message sg"> Aggiungi record densità: </span><span class="message og"> Imposta densità OG: </span><p> Per favore imposta la densità (valore). </p><ul style=list-style-type:none><li><input class=sginput type=text size=6 value=1.0 onchange=inputsg_change()> <span class=platounit>&deg;P</span> @ <input class=tempinput type=text size=6 value=20 onchange=inputsg_change()><sapn class=temp-unit>&deg;C</sapn></li><li>~ <span id=sginput-hmc></span><span class=platounit>&deg;P</span> @ <span id=sginput-hm-cal-temp></span><sapn class=temp-unit>&deg;C</sapn></li><li>~ <span id=sginput-sg-ispindel></span><span class=platounit>&deg;P</span> @ <span id=sginput-ispindel-temp></span><sapn class=temp-unit>&deg;C</sapn></li></ul><div class=dialog-buttons><button onclick=dismissgravity()>Cancella</button> <button onclick=inputgravity()>OK</button></div></div></div><div id=dlg_saveas class=modal><div class=modal-content><span class=message>Salva Profilo come</span><br><input type=text size=32><br> *Non sono permessi caratteri speciali o spazi. <button onclick=PL.cancelSave()>Cancella </button> <button onclick=PL.doSave()>OK</button></div></div><div id=profile-list-pane class=modal><div class=modal-content><h3 class=profile-load-heading> carica Profilo </h3><hr><ul class=profile-list style="margin:16px 0"><li style="margin:8px 0"><button class=rmbutton>cancella </button> <a href=# class=profile-name></a></li></ul><hr><button class=btn onclick=PL.toggle()>Cancella</button></div></div><div id=polynomialpane class=modal><div class=modal-content><div id=xclose onclick=closepolynomialpane()>X</div><table><tr><td><table id=pointlist><thead><tr><th> Angolo </th><th> SG <span class=platounit>&deg;P</span></th><th> Calcolato </th><th> Errore </th><th> Ignorato </th></tr></thead><tbody><tr class=pl_calpoint><td class=pl_tilt></td><td class=pl_sg></td><td class=pl_value></td><td class=pl_error></td><td><input class=pl_ignored_cb type=checkbox></td></tr></tbody></table><div style=float:right><button onclick=applyIgnoreMask()>Applica</button></div></td><td><div id=graph></div><span id=polynormial></span></td></tr></table></div></div></body></html>